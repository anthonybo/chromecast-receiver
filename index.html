<!DOCTYPE html>
<html>
<head>
    <title>Custom Chromecast Receiver</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mux.js/7.0.3/mux.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        #logs {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: scroll;
            z-index: 10000;
            color: white;
            font-size: 16px;
        }
        .log-entry {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <audio id="audio" controls autoplay></audio>
    <div id="logs"></div>

    <script>
        function log(message) {
            const logsElement = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.classList.add('log-entry');
            logEntry.textContent = message;
            logsElement.appendChild(logEntry);
            console.log(message);
        }

        function logError(error) {
            let errorMessage = "Error: ";
            if (error && error.message) {
                errorMessage += error.message;
            } else if (error && typeof error === 'object') {
                errorMessage += JSON.stringify(error, null, 2);
            } else {
                errorMessage += error.toString();
            }
            log(errorMessage);
        }

        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        // Set the HLS segment format to TS explicitly for the LOAD request
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            async (request) => {
                // Override the HLS segment format to MPEG2_TS
                request.media.contentType = 'application/x-mpegurl';
                request.media.hlsSegmentFormat = cast.framework.messages.HlsSegmentFormat.FMP4;

                const url = new URL(request.media.contentId);
                const encodedUrl = `${url.origin}${url.pathname}?${url.searchParams}`;

                log('LOAD interceptor called with media: ' + encodedUrl);

                const audioElement = document.getElementById('audio');
                const player = new shaka.Player(audioElement);

                player.addEventListener('error', event => {
                    logError('Shaka Player Detailed Error: ' + event.detail.code + ' - ' + shaka.util.Error.categorize(event.detail).toString());
                });

                try {
                    await player.load(encodedUrl);
                    log('The audio has now been loaded!');
                    const stats = player.getStats();
                    log('Load Stats: ' + JSON.stringify(stats));
                } catch (error) {
                    logError(error);
                    return Promise.reject(new cast.framework.messages.ErrorData(cast.framework.messages.ErrorType.LOAD_FAILED));
                }

                return request;
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            (event) => logError("Chromecast Player Error: " + JSON.stringify(event))
        );

        let castReceiverOptions = new cast.framework.CastReceiverOptions();
        castReceiverOptions.useShakaForHls = true;
        context.start(castReceiverOptions);

        log('Custom Chromecast Receiver started. Shaka enabled for HLS with specified segment formats.V3');
    </script>
</body>
</html>
