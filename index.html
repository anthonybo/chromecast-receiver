<!DOCTYPE html>
<html>
<head>
  <title>Custom Chromecast Receiver</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mux.js/7.0.3/mux.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js" integrity="sha512-a2B3X7hta/s/ge8bxKVWHhH6ecX2fL6mqQeN3sjioqI4ntS/rP2sLZchNKYK2KXNcreD0xP4Vo7vRsI3WIy3sg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="text/javascript" src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <style>
    #logs {
      position: fixed; /* Use fixed positioning to ensure visibility across the screen */
      top: 0; /* Align to the top of the screen */
      left: 0; /* Align to the left of the screen */
      right: 0; /* Stretch across the entire width of the screen */
      bottom: 0; /* Stretch from top to bottom, making full use of the screen height */
      overflow-y: scroll; /* Allow scrolling through logs if they exceed screen height */
      z-index: 10000; /* Ensure the log container is on top of other content */
      color: white;
      font-size: 16px;
    }
    .log-entry {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px;
      margin-bottom: 5px; /* Space out log entries for readability */
    }
  </style>
</head>
<body>

<audio id="audio" autoplay controls></audio>
<div id="logs"></div>

<script>
  function log(message) {
    const logsElement = document.getElementById('logs');
    // Create a new div for each log message
    const logEntry = document.createElement('div');
    logEntry.classList.add('log-entry'); // Apply styles to each log entry
    logEntry.textContent = message;

    logsElement.appendChild(logEntry);
    console.log(message); // Also log to console
  }

  // Updated logging function to handle long error messages
  function logError(error) {
    let errorMessage = "Error: ";
    if (error && error.detail && error.detail.message) {
      // Attempt to log a concise error message
      errorMessage += error.detail.message;
    } else if (error && typeof error === 'object') {
      // Fallback to logging the entire error object if concise message isn't available
      errorMessage += JSON.stringify(error, null, 2); // Pretty print the error object
    } else {
      errorMessage += error.toString();
    }
    log(errorMessage);
  }

  const context = cast.framework.CastReceiverContext.getInstance();
  const playerManager = context.getPlayerManager();

  let castReceiverOptions = new cast.framework.CastReceiverOptions();
  castReceiverOptions.useShakaForHls = true;
  context.start(castReceiverOptions);

  playerManager.setMessageInterceptor(
    cast.framework.messages.MessageType.LOAD,
    async (request) => {
      const url = new URL(request.media.contentId);
      const encodedSearchParams = new URLSearchParams(url.search);
      const encodedUrl = `${url.origin}${url.pathname}?${encodedSearchParams}`;

      log('LOAD interceptor called with media: ' + encodedUrl);

      const player = new shaka.Player(document.getElementById('audio'));

      // Force transmuxing TS segments
      // player.configure('streaming.forceTransmuxTS', true);
      player.configure({
        streaming: {
          forceTransmuxTS: true,
          jumpLargeGaps: true,
        }
      });

      player.addEventListener('error', event => {
        // Enhanced error logging
        logError('Shaka Player Error: ' + JSON.stringify(event.detail));

        // Attempt to get stats after an error for more insights
        const stats = player.getStats();
        log('Error Stats: ' + JSON.stringify(stats));
      });

      // Diagnostic Check: Log the manifest to examine its details
      fetch(encodedUrl).then(response => response.text()).then(manifest => {
        // log("Manifest content: \n" + manifest.substring(0, 500)); // Log first 500 characters of manifest
      }).catch(error => logError("Failed to fetch manifest: " + error));

      try {
        await player.load(encodedUrl);
        log('The audio has now been loaded!');
        
        // Optionally perform checks after successful load
        const stats = player.getStats();
        log('Load Stats: ' + JSON.stringify(stats));
      } catch (error) {
        logError(error);
        return Promise.reject(new cast.framework.messages.ErrorData(cast.framework.messages.ErrorType.LOAD_FAILED));
      }

      return request;
    });

  playerManager.addEventListener(
    cast.framework.events.EventType.ERROR,
    (event) => {
      logError("Chromecast Player Error: " + JSON.stringify(event.detail));
    });

  log('Custom Chromecast Receiver started. Shaka enabled for HLS with Mux.js for TS to MP4 transmuxing. Diagnostic checks added.V21');
</script>

</body>
</html>
